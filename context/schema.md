# Schema & Structure
Last updated: 2025-11-19

## Repository Layout (high level)
- `src/app`
  - `/map` — Server + client pair powering Mapbox discovery (food banks, events, posts, quick RSVP).
  - `/community` — Modular community layout (page-client orchestrator, components/, events calendar).
  - `/chat` + `/chat-v2` — Vercel AI SDK legacy chat + CopilotKit experience.
  - `/api/*` — App Router API routes (chat tools, posts, events, slots, RSVPs, CopilotKit runtime).
  - `/admin` — Admin-only layout + verification dashboard; gated via `withAdminAuth` and backed by `/api/admin/resources` + `/api/admin/resources/[id]/enhance`.
- `src/components`
  - `map/` shared Mapbox primitives (`MapView`, search bar, popups).
  - `ui/` (shadcn), `navigation/` (bottom nav), `chat-v2/components` (tool renderers, cards).
- `src/lib`
  - `schema.ts` Drizzle models (Better Auth, food resources, community, events).
  - Query/helpers: `food-bank-queries.ts`, `post-queries.ts`, `event-queries.ts`, `admin-queries.ts`, `auth-middleware.ts`, `auth/admin.ts`, `admin-enhancer.ts`.
- `scripts/` — Tool smoke tests (`dev-terminal-chat.ts`, `test-chat-tools.ts`) and data utilities.
- `context/` — Long-term documentation (this folder).

## Database (Supabase Postgres + Drizzle)

### Core resource tables
- `food_banks`
  - Columns: `id`, `name`, address fields, `latitude`, `longitude`, `services` (text[]), `hours` (json), contact info, `createdAt/updatedAt`.
  - Used by map + chat search tools; `services` normalized for filters. Admin dashboard now highlights missing address/phone/website/hours via derived SQL filters (blank text OR `(0,0)` coords).
- `saved_locations`
  - Links Better Auth `userId` → preferred `foodBankId`; stored for quick recall in chat intents.
- `chat_messages`
  - Stores historic sous-chef interactions (`sessionId`, `role`, `content`, optional `metadata`).

### Community / social tables
- `posts`
  - Fields: `id`, `userId`, `content`, `kind` (`share|request|update|resource|event`), `mood`, `location`, `locationCoords`, `expiresAt`, `urgency`, `photoUrl`, engagement counters, timestamps.
- `comments`
  - Feed replies w/ `postId`, `userId`, `content`, `createdAt`.
- `userProfiles`
  - Extended Better Auth attributes: `userId`, `karma`, `role`, `bio`, stats.
- `follows`
  - Many-to-many follow graph (`followerId`, `followingId`, `createdAt`).
- `helpfulMarks`
  - Reaction table tracking which users marked posts/comments as helpful for karma.

### Event hosting tables
- `events`
  - Metadata: `id`, `postId`, `hostId`, `title`, `description`, `eventType` (`potluck|volunteer`), timing, location text + coords, `isPublicLocation`, `capacity`, denormalized counts, verification + recurrence pointers, status, timestamps.
- `eventRsvps`
  - `eventId`, `userId`, `status` (`attending|waitlisted|declined`), `guestCount`, `notes`, audit timestamps (unique on event/user).
- `signUpSlots`
  - Potluck slots per event (`slotName`, `maxClaims`, `claimCount`, `description`, `sortOrder`).
- `signUpClaims`
  - Claim records linking user ↔ slot with optional `details`. Unique per slot/user.
- `eventRecurrence`
  - Recurring pattern template (frequency, `dayOfWeek`, `dayOfMonth`, `interval`, optional `endsAt`).
- `eventAttendance`
  - Host check-in log once events complete (`checkedInAt`, `notes`).

### Auth + support tables
- Better Auth tables (`user`, `session`, `account`, `verificationToken`) are generated by the auth package and referenced via Drizzle relations.
- `copilotRunLogs` (coming soon) will capture CopilotKit action telemetry once required for debugging.
- Admin tooling relies on `userProfiles.role` (`admin`) or `ADMIN_USER_ID` env override to grant access without new tables.

### Relationships & helpers
- `schema.ts` defines relations via `relations()` (e.g., `eventsRelations`, `postsRelations`) so query helpers (`post-queries.ts`, `event-queries.ts`) can eager-load authors, profiles, RSVP counts.
- `@/lib/post-queries.ts` implements cursor pagination (`createdAt`, `id`) plus filters (`kind`, `mood`, `following`, `onlyWithCoords`).
- `@/lib/event-queries.ts` handles status filtering, date windows, slot aggregation, and denormalized counter maintenance.
- `@/lib/admin-queries.ts` surfaces unverified resources with derived flags (missingHours, missingPhone, missingWebsite, missingDescription, missingAddress, potentialDuplicate) and batch status updates for the dashboard.

## Environment Variables (must exist in `.env`)
- `POSTGRES_URL` (Supabase connection string)
- `BETTER_AUTH_SECRET`
- `GOOGLE_CLIENT_ID` / `GOOGLE_CLIENT_SECRET`
- `NEXT_PUBLIC_APP_URL`
- `NEXT_PUBLIC_MAPBOX_TOKEN`
- `OPENROUTER_API_KEY` (+ optional `OPENROUTER_MODEL`)
- Optional integrations: `POLAR_WEBHOOK_SECRET`, `POSTHOG_KEY`, etc.
- Admin AI features additionally need `TAVILY_API_KEY`, `OPENROUTER_API_KEY`, and (optionally) `OPENROUTER_MODEL`. Missing keys degrade gracefully by returning config errors to the dashboard UI.

## Seed & Data Hygiene Notes
- Food bank hours are stored as `{ mon: { open: "09:00", close: "17:00", closed?: boolean }, ... }`. Keep keys consistent for `isCurrentlyOpen` helper.
- `services` should use normalized labels (“Emergency Groceries”, “CalFresh Assistance”) for reliable filtering.
- `locationCoords` are approximate (lat/lng) and should only be stored when users consent; map layer queries always filter `IS NOT NULL` before rendering.
- RSVP + slot counters are denormalized; always update via helper functions in `event-queries.ts` so counts stay consistent.
- Admin enhancer currently sends structured prompts to OpenRouter. Known issue: provider rejects JSON schemas if optional properties are not listed under a `required` array. We temporarily wrap optional outputs inside an `updates` object and parse `hours` from string form, but errors persist whenever the provider changes validation rules (see context/state.md for active error logs).
